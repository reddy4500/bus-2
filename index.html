<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YASWANTH Fleet Audit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .page {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        [contenteditable="true"] {
            cursor: pointer;
            outline: none;
            background-color: rgba(239, 246, 255, 0.5);
            padding: 2px 4px;
            border-radius: 4px;
            transition: all 0.2s ease-in-out;
        }
        [contenteditable="true"]:hover {
             background-color: rgba(224, 231, 255, 0.7);
        }
        [contenteditable="true"]:focus {
            background-color: white;
            box-shadow: 0 0 0 2px #6366f1;
        }
        [contenteditable=true]:empty:before {
            content: attr(data-placeholder);
            color: #94a3b8;
            font-style: italic;
        }
        .yaswanth-title {
            background: linear-gradient(to right, #6366f1, #a855f7, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
        }
        .nav-link.active {
            color: #4f46e5;
            font-weight: 600;
        }
        .month-selector a.current-month {
            background-color: #4f46e5;
            color: white;
            font-weight: 700;
            border-color: #4338ca;
        }
        .dashboard-card {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        tbody tr {
            transition: background-color 0.2s ease-in-out;
        }
        tbody tr:hover {
            background-color: rgba(241, 245, 249, 1) !important;
        }
        /* Diesel table cross-hair highlighting */
        #diesel-table .highlight-row,
        #diesel-table .highlight-col {
            background-color: #e0e7ff !important;
        }
        #diesel-table .highlight-row .sticky,
        #diesel-table .highlight-col .sticky {
             background-color: #c7d2fe !important;
        }
        /* Loader styles */
        #loader {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        .spinner {
            width: 56px;
            height: 56px;
            border: 8px solid #e5e7eb;
            border-top-color: #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast Notification styles */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: slideIn 0.3s ease-out, fadeOut 0.5s ease-in 3.5s forwards;
        }
        .toast.success { background-color: #22c55e; }
        .toast.error { background-color: #ef4444; }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; transform: translateY(-20px); height: 0; padding: 0; margin: 0;}
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-100 to-indigo-200 text-slate-800">

    <div id="loader"><div class="spinner"></div></div>
    <div id="toast-container"></div>

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">

        <header class="flex justify-between items-center mb-8 bg-white/60 backdrop-blur-lg fixed top-4 left-1/2 -translate-x-1/2 w-[calc(100%-2rem)] md:w-[calc(100%-4rem)] max-w-7xl z-50 p-4 md:p-6 rounded-xl shadow-lg shadow-slate-900/5 border border-white/50">
            <div class="flex items-center gap-2">
                <h1 class="text-4xl font-extrabold yaswanth-title">Yaswanth</h1>
            </div>
            <nav id="desktop-nav" class="hidden md:flex space-x-8">
                <a href="#" onclick="showPage('home')" id="nav-home" class="nav-link text-slate-600 hover:text-indigo-500 font-medium transition-colors">Home</a>
                <a href="#" onclick="showPage('bus-wise-audit')" id="nav-bus-wise-audit" class="nav-link text-slate-600 hover:text-indigo-500 font-medium transition-colors">Fleet Reports</a>
                <a href="#" onclick="showPage('payroll-selection')" id="nav-payroll-selection" class="nav-link text-slate-600 hover:text-indigo-500 font-medium transition-colors">Payroll</a>
            </nav>
            <button id="mobile-menu-button" class="md-hidden text-slate-600 hover:text-indigo-500">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
        </header>

        <div id="mobile-menu" class="hidden md:hidden bg-slate-50 rounded-xl shadow-lg mb-8 p-4 fixed top-24 left-4 right-4 z-40">
            <a href="#" onclick="showPage('home')" class="nav-link block py-2 text-slate-600 hover:text-indigo-500 rounded-md px-3">Home</a>
            <a href="#" onclick="showPage('bus-wise-audit')" class="nav-link block py-2 text-slate-600 hover:text-indigo-500 rounded-md px-3">Fleet Reports</a>
            <a href="#" onclick="showPage('payroll-selection')" class="nav-link block py-2 text-slate-600 hover:text-indigo-500 rounded-md px-3">Payroll</a>
        </div>

        <div class="h-24"></div>

        <main id="home" class="page">
            <div class="text-center mb-12">
                <h2 class="text-4xl font-bold mb-2 text-slate-900">Dashboard</h2>
                <p class="text-slate-500 text-lg">Select an option to begin.</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                <div class="group dashboard-card p-8 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-1 cursor-pointer" onclick="showPage('monthly-audit-selection')">
                    <div class="flex items-center justify-center h-16 w-16 rounded-full bg-indigo-100 text-indigo-600 mb-6 group-hover:bg-indigo-600 group-hover:text-white transition-colors">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </div>
                    <h3 class="text-2xl font-semibold mb-3 text-slate-800">Monthly Audit Entry</h3>
                    <p class="text-slate-500 mb-6">Enter financial data for each month and bus.</p>
                    <span class="font-semibold text-indigo-600 group-hover:underline">
                        Go to Data Entry &rarr;
                    </span>
                </div>
                 <div class="group dashboard-card p-8 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-1 cursor-pointer" onclick="showPage('diesel-selection')">
                    <div class="flex items-center justify-center h-16 w-16 rounded-full bg-purple-100 text-purple-600 mb-6 group-hover:bg-purple-600 group-hover:text-white transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3zm3.146 5.146L8 10.001V15l1.001-1-1.147-1.146a1 1 0 010-1.414l-1.414-1.414a1 1 0 010-1.414L8.586 8l-2.44-2.44A.5.5 0 016.5 5H4v2.5a.5.5 0 01.146.354z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <h3 class="text-2xl font-semibold mb-3 text-slate-800">Diesel Audit</h3>
                    <p class="text-slate-500 mb-6">Track daily diesel consumption for the fleet.</p>
                     <span class="font-semibold text-purple-600 group-hover:underline">
                        Go to Diesel Log &rarr;
                    </span>
                </div>
                <div class="group dashboard-card p-8 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-1 cursor-pointer" onclick="showPage('bus-wise-audit')">
                     <div class="flex items-center justify-center h-16 w-16 rounded-full bg-teal-100 text-teal-600 mb-6 group-hover:bg-teal-600 group-hover:text-white transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" />
                          <path stroke-linecap="round" stroke-linejoin="round" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" />
                        </svg>
                    </div>
                    <h3 class="text-2xl font-semibold mb-3 text-slate-800">View Fleet Reports</h3>
                    <p class="text-slate-500 mb-6">Analyze aggregated profit, loss, and revenue data.</p>
                     <span class="font-semibold text-teal-600 group-hover:underline">
                        Go to Reports &rarr;
                    </span>
                </div>
                <div class="group dashboard-card p-8 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-1 cursor-pointer" onclick="showPage('payroll-selection')">
                     <div class="flex items-center justify-center h-16 w-16 rounded-full bg-amber-100 text-amber-600 mb-6 group-hover:bg-amber-600 group-hover:text-white transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                    </div>
                    <h3 class="text-2xl font-semibold mb-3 text-slate-800">Payroll</h3>
                    <p class="text-slate-500 mb-6">Calculate and manage driver payments and deductions.</p>
                     <span class="font-semibold text-amber-600 group-hover:underline">
                        Go to Payroll &rarr;
                    </span>
                </div>
            </div>
        </main>

        <section id="monthly-audit-selection" class="page bg-slate-50 p-8 rounded-2xl shadow-lg">
            <div class="flex items-center mb-8">
                <button onclick="showPage('home')" class="flex items-center text-indigo-600 hover:text-indigo-800 font-medium transition-colors mr-6">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                    Back
                </button>
                <h2 class="text-3xl font-bold text-slate-900">Select Audit Period</h2>
            </div>
            <div class="month-selector grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                <a href="#" onclick="showAuditFile('January')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-indigo-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">January</a>
                <a href="#" onclick="showAuditFile('February')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-indigo-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">February</a>
                <a href="#" onclick="showAuditFile('March')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-indigo-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">March</a>
                <a href="#" onclick="showAuditFile('April')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-indigo-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">April</a>
                <a href="#" onclick="showAuditFile('May')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-indigo-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">May</a>
                <a href="#" onclick="showAuditFile('June')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-indigo-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">June</a>
                <a href="#" onclick="showAuditFile('July')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-indigo-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">July</a>
                <a href="#" onclick="showAuditFile('August')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-indigo-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">August</a>
                <a href="#" onclick="showAuditFile('September')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-indigo-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">September</a>
                <a href="#" onclick="showAuditFile('October')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-indigo-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">October</a>
                <a href="#" onclick="showAuditFile('November')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-indigo-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">November</a>
                <a href="#" onclick="showAuditFile('December')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-indigo-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">December</a>
            </div>
        </section>

        <section id="audit-file" class="page bg-slate-50 p-8 rounded-2xl shadow-lg">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4">
                <div class="flex items-center">
                    <button onclick="showPage('monthly-audit-selection')" class="flex items-center text-indigo-600 hover:text-indigo-800 font-medium transition-colors mr-6">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                        Back
                    </button>
                    <div>
                        <h2 class="text-3xl font-bold text-slate-900">Audit File: <span id="audit-file-month"></span></h2>
                        <p class="text-sm text-slate-500">Totals update as you type. Click Save to persist changes.</p>
                    </div>
                </div>
                <div class="relative">
                    <input type="text" id="audit-search" onkeyup="filterAuditTable()" placeholder="Search by Bus Number..." class="pl-10 pr-4 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    <svg class="w-5 h-5 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                </div>
            </div>
            
            <div class="flex justify-between items-center mb-4">
                <button onclick="addRow()" class="flex items-center gap-2 bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600 transition-colors shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    Add Row
                </button>
                <div class="flex gap-4">
                     <button onclick="exportToCSV()" class="flex items-center gap-2 bg-slate-600 text-white px-4 py-2 rounded-lg hover:bg-slate-700 transition-colors shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a1 1 0 00-1 1v1a1 1 0 002 0V3a1 1 0 00-1-1zM4 4h3a1 1 0 000-2H4a1 1 0 000 2zM8 16a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1zM4 16a1 1 0 011-1h2a1 1 0 110 2H5a1 1 0 01-1-1z" /><path fill-rule="evenodd" d="M5 8a3 3 0 016 0v8a3 3 0 11-6 0V8zm3-1a1 1 0 00-1 1v8a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        Export
                    </button>
                    <button onclick="saveTableData()" class="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors shadow-md hover:shadow-lg font-semibold">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                        Save Changes
                    </button>
                </div>
            </div>

            <div class="overflow-y-auto rounded-lg border max-h-[60vh]">
                <table class="min-w-full">
                    <thead class="bg-slate-100 sticky top-0 z-10">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">S.No</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Bus Number</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Credited Money</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Expenses</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Money Left</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">Action</th>
                        </tr>
                    </thead>
                    <tbody class="bg-slate-50 divide-y divide-slate-200" id="audit-table-body"></tbody>
                    <tfoot class="bg-slate-200 font-bold" id="audit-table-foot"></tfoot>
                </table>
            </div>
        </section>

        <section id="diesel-selection" class="page bg-slate-50 p-8 rounded-2xl shadow-lg">
            <div class="flex items-center mb-8">
                <button onclick="showPage('home')" class="flex items-center text-purple-600 hover:text-purple-800 font-medium transition-colors mr-6">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                    Back
                </button>
                <h2 class="text-3xl font-bold text-slate-900">Select Diesel Audit Month</h2>
            </div>
            <div class="month-selector grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                <a href="#" onclick="showDieselFile('January')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-purple-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">January</a>
                <a href="#" onclick="showDieselFile('February')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-purple-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">February</a>
                <a href="#" onclick="showDieselFile('March')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-purple-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">March</a>
                <a href="#" onclick="showDieselFile('April')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-purple-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">April</a>
                <a href="#" onclick="showDieselFile('May')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-purple-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">May</a>
                <a href="#" onclick="showDieselFile('June')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-purple-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">June</a>
                <a href="#" onclick="showDieselFile('July')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-purple-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">July</a>
                <a href="#" onclick="showDieselFile('August')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-purple-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">August</a>
                <a href="#" onclick="showDieselFile('September')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-purple-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">September</a>
                <a href="#" onclick="showDieselFile('October')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-purple-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">October</a>
                <a href="#" onclick="showDieselFile('November')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-purple-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">November</a>
                <a href="#" onclick="showDieselFile('December')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-purple-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">December</a>
            </div>
        </section>

        <section id="diesel-file" class="page bg-slate-50 p-8 rounded-2xl shadow-lg">
             <div class="flex items-center mb-1">
                <button onclick="showPage('diesel-selection')" class="flex items-center text-purple-600 hover:text-purple-800 font-medium transition-colors mr-6">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                    Back
                </button>
                <h2 class="text-3xl font-bold text-slate-900">Diesel Log: <span id="diesel-file-month"></span></h2>
            </div>
            <p class="text-sm text-slate-500 mb-6 ml-16">Hover for crosshair view. Totals update as you type.</p>
            
            <div class="flex justify-end items-center mb-4">
                <div class="flex gap-4">
                     <button onclick="exportDieselToCSV()" class="flex items-center gap-2 bg-slate-600 text-white px-4 py-2 rounded-lg hover:bg-slate-700 transition-colors shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a1 1 0 00-1 1v1a1 1 0 002 0V3a1 1 0 00-1-1zM4 4h3a1 1 0 000-2H4a1 1 0 000 2zM8 16a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1zM4 16a1 1 0 011-1h2a1 1 0 110 2H5a1 1 0 01-1-1z" /><path fill-rule="evenodd" d="M5 8a3 3 0 016 0v8a3 3 0 11-6 0V8zm3-1a1 1 0 00-1 1v8a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        Export
                    </button>
                    <button onclick="saveDieselData()" class="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors shadow-md hover:shadow-lg font-semibold">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                        Save Changes
                    </button>
                </div>
            </div>

            <div class="overflow-auto rounded-lg border max-h-[65vh]">
                <table id="diesel-table" class="min-w-full text-sm">
                    <thead class="bg-slate-100 sticky top-0 z-10" id="diesel-table-head"></thead>
                    <tbody class="bg-slate-50 divide-y divide-slate-200" id="diesel-table-body"></tbody>
                    <tfoot class="bg-slate-200 font-bold sticky bottom-0" id="diesel-table-foot"></tfoot>
                </table>
            </div>
        </section>


        <section id="bus-wise-audit" class="page bg-slate-50 p-8 rounded-2xl shadow-lg">
            <div class="flex items-center mb-6">
                <button onclick="showPage('home')" class="flex items-center text-teal-600 hover:text-teal-800 font-medium transition-colors mr-6">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                    Back
                </button>
                <h2 class="text-3xl font-bold text-slate-900">Aggregated Fleet Reports</h2>
            </div>
            
            <div id="charts-container" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                 <div class="lg:col-span-2 bg-white p-6 rounded-lg border shadow-sm">
                    <h3 class="text-xl font-semibold mb-4 text-center text-slate-700">Overall Profit vs. Loss by Bus</h3>
                    <canvas id="busProfitLossChart"></canvas>
                </div>
                <div class="lg:col-span-1 bg-white p-6 rounded-lg border shadow-sm">
                     <h3 class="text-xl font-semibold mb-4 text-center text-slate-700">Total Revenue Share by Bus</h3>
                     <canvas id="revenuePieChart"></canvas>
                </div>
            </div>

            <div id="bus-specific-analysis-section" class="hidden">
                <hr class="my-10 border-slate-300">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6">
                    <h2 class="text-3xl font-bold text-slate-900 mb-4 sm:mb-0">Individual Bus Performance</h2>
                    <div>
                        <label for="bus-selector" class="font-medium mr-2 text-slate-600">Select a Bus:</label>
                        <select id="bus-selector" class="p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></select>
                    </div>
                </div>
                <div id="bus-details-container" class="hidden grid grid-cols-1 xl:grid-cols-3 gap-8 items-start">
                    <div class="xl:col-span-1 bg-white p-6 rounded-lg border shadow-sm flex flex-col gap-4">
                        <h3 class="text-xl font-semibold mb-2 text-slate-800 border-b pb-2">Analysis for Bus: <span id="details-bus-number" class="text-indigo-600 font-bold"></span></h3>
                        <div class="flex justify-between items-center bg-slate-100 p-3 rounded-md">
                            <span class="font-semibold text-slate-600">Total Revenue:</span>
                            <span id="details-total-revenue" class="font-bold text-green-600 text-lg"></span>
                        </div>
                         <div class="flex justify-between items-center bg-slate-100 p-3 rounded-md">
                            <span class="font-semibold text-slate-600">Total Expenses:</span>
                            <span id="details-total-expense" class="font-bold text-red-600 text-lg"></span>
                        </div>
                         <div class="flex justify-between items-center bg-slate-100 p-3 rounded-md">
                            <span class="font-semibold text-slate-600">Net Profit:</span>
                            <span id="details-net-profit" class="font-bold text-lg"></span>
                        </div>
                        <hr class="my-2">
                         <div class="flex justify-between items-center bg-green-100 p-3 rounded-md border border-green-200">
                            <span class="font-semibold text-green-800">Best Month:</span>
                            <div>
                                <span id="details-best-month" class="font-bold text-green-800"></span>
                                <span id="details-best-profit" class="text-sm text-green-700 block text-right"></span>
                            </div>
                        </div>
                         <div class="flex justify-between items-center bg-red-100 p-3 rounded-md border border-red-200">
                            <span class="font-semibold text-red-800">Worst Month:</span>
                            <div>
                                <span id="details-worst-month" class="font-bold text-red-800"></span>
                                <span id="details-worst-profit" class="text-sm text-red-700 block text-right"></span>
                            </div>
                        </div>
                    </div>
                    <div class="xl:col-span-2 bg-white p-6 rounded-lg border shadow-sm">
                        <h3 class="text-xl font-semibold mb-4 text-center text-slate-700">Monthly Performance Trend</h3>
                        <canvas id="monthlyBusChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="no-charts-message" class="hidden text-center py-16 flex-col items-center">
                 <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                    <path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2z" />
                </svg>
                <h3 class="mt-2 text-2xl font-semibold text-slate-700">No Data Available</h3>
                <p class="mt-1 text-slate-500">Please enter some data in the 'Monthly Audit Entry' section to generate reports.</p>
            </div>
        </section>
        <section id="payroll-selection" class="page bg-slate-50 p-8 rounded-2xl shadow-lg">
            <div class="flex items-center mb-8">
                <button onclick="showPage('home')" class="flex items-center text-amber-600 hover:text-amber-800 font-medium transition-colors mr-6">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                    Back
                </button>
                <h2 class="text-3xl font-bold text-slate-900">Select Payroll Month</h2>
            </div>
            <div class="month-selector grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                <a href="#" onclick="showPayrollFile('January')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-amber-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">January</a>
                <a href="#" onclick="showPayrollFile('February')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-amber-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">February</a>
                <a href="#" onclick="showPayrollFile('March')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-amber-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">March</a>
                <a href="#" onclick="showPayrollFile('April')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-amber-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">April</a>
                <a href="#" onclick="showPayrollFile('May')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-amber-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">May</a>
                <a href="#" onclick="showPayrollFile('June')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-amber-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">June</a>
                <a href="#" onclick="showPayrollFile('July')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-amber-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">July</a>
                <a href="#" onclick="showPayrollFile('August')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-amber-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">August</a>
                <a href="#" onclick="showPayrollFile('September')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-amber-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">September</a>
                <a href="#" onclick="showPayrollFile('October')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-amber-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">October</a>
                <a href="#" onclick="showPayrollFile('November')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-amber-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">November</a>
                <a href="#" onclick="showPayrollFile('December')" class="text-center font-medium p-4 bg-white shadow-sm border rounded-lg hover:bg-amber-500 hover:text-white hover:shadow-lg transition-all duration-200 transform hover:scale-105">December</a>
            </div>
        </section>

        <section id="payroll-file" class="page bg-slate-50 p-8 rounded-2xl shadow-lg">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4">
                <div class="flex items-center">
                    <button onclick="showPage('payroll-selection')" class="flex items-center text-amber-600 hover:text-amber-800 font-medium transition-colors mr-6">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                        Back
                    </button>
                    <div>
                        <h2 class="text-3xl font-bold text-slate-900">Payroll Report: <span id="payroll-file-month"></span></h2>
                         <p class="text-sm text-slate-500">Calculated fields update automatically as you type.</p>
                    </div>
                </div>
                 <div class="relative">
                    <input type="text" id="payroll-search" onkeyup="filterPayrollTable()" placeholder="Search by Driver Name..." class="pl-10 pr-4 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                    <svg class="w-5 h-5 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                </div>
            </div>
            
            <div class="flex justify-between items-center mb-4">
                <button onclick="addPayrollRow()" class="flex items-center gap-2 bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600 transition-colors shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    Add Row
                </button>
                <div class="flex gap-4">
                     <button onclick="exportPayrollToCSV()" class="flex items-center gap-2 bg-slate-600 text-white px-4 py-2 rounded-lg hover:bg-slate-700 transition-colors shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a1 1 0 00-1 1v1a1 1 0 002 0V3a1 1 0 00-1-1zM4 4h3a1 1 0 000-2H4a1 1 0 000 2zM8 16a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1zM4 16a1 1 0 011-1h2a1 1 0 110 2H5a1 1 0 01-1-1z" /><path fill-rule="evenodd" d="M5 8a3 3 0 016 0v8a3 3 0 11-6 0V8zm3-1a1 1 0 00-1 1v8a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        Export
                    </button>
                    <button onclick="savePayrollData()" class="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors shadow-md hover:shadow-lg font-semibold">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                        Save Changes
                    </button>
                </div>
            </div>

            <div class="overflow-auto rounded-lg border max-h-[60vh]">
                <table class="min-w-full text-sm">
                    <thead class="bg-slate-100 sticky top-0 z-10">
                        <tr>
                            <th class="p-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Name</th>
                            <th class="p-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Vehicle No</th>
                            <th class="p-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Opted KM</th>
                            <th class="p-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Slab Rate</th>
                            <th class="p-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider bg-slate-200/60">Amount Payable</th>
                            <th class="p-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Insurance</th>
                            <th class="p-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Oil Saved</th>
                            <th class="p-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider bg-slate-200/60">Total Payable</th>
                            <th class="p-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Income Tax</th>
                            <th class="p-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Penalty</th>
                            <th class="p-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Less Other (Oil)</th>
                            <th class="p-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider bg-slate-200/60">Total Deduction</th>
                            <th class="p-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider bg-indigo-100">Net Payable</th>
                            <th class="p-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">Action</th>
                        </tr>
                    </thead>
                    <tbody class="bg-slate-50 divide-y divide-slate-200" id="payroll-table-body"></tbody>
                    <tfoot class="bg-slate-200 font-bold" id="payroll-table-foot"></tfoot>
                </table>
            </div>
        </section>

        <footer class="text-center mt-12 text-slate-500 text-sm">
            <p>&copy; <span id="current-year"></span> Yaswanth Fleet Management. All Rights Reserved.</p>
        </footer>
    </div>

    <script>
        // --- Firebase Configuration & Initialization ---
        const firebaseConfig = {
            apiKey: "AIzaSyBQrSN31bs0dqpyZVT_IeGktPEy7rMrqcQ",
            authDomain: "yaswanth-fleet.firebaseapp.com",
            databaseURL: "https://yaswanth-fleet-default-rtdb.firebaseio.com",
            projectId: "yaswanth-fleet",
            storageBucket: "yaswanth-fleet.appspot.com",
            messagingSenderId: "44710091269",
            appId: "1:44710091269:web:6bffc1ab51aa52723e9a6c",
            measurementId: "G-LLY5VJN3N6"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // --- Global Variables ---
        const pages = document.querySelectorAll('.page');
        let profitLossChartInstance = null;
        let revenuePieChartInstance = null;
        let monthlyBusChartInstance = null;
        const DIESEL_BUS_NUMBERS = ['9721', '9722', '9932', '9935', '9937', '9938', '4680', '4681', '4319', '4320'];
        const MONTH_NAMES = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];


        // --- UI Interaction Functions (Loader, Toast, etc.) ---
        const showLoader = () => document.getElementById('loader').style.display = 'flex';
        const hideLoader = () => document.getElementById('loader').style.display = 'none';

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => { toast.remove(); }, 4000);
        }

        function highlightCurrentMonth() {
            const currentMonthName = MONTH_NAMES[new Date().getMonth()];
            document.querySelectorAll('.month-selector a').forEach(el => {
                el.classList.remove('current-month');
                if (el.textContent === currentMonthName) {
                    el.classList.add('current-month');
                }
            });
        }
        
        // --- Page Navigation ---
        const pageToNavMap = {
            'home': 'nav-home', 'monthly-audit-selection': 'nav-home', 'audit-file': 'nav-home',
            'diesel-selection': 'nav-home', 'diesel-file': 'nav-home', 'bus-wise-audit': 'nav-bus-wise-audit',
            'payroll-selection': 'nav-payroll-selection', 'payroll-file': 'nav-payroll-selection',
        };

        function showPage(pageId) {
            pages.forEach(page => page.style.display = 'none');
            const activePage = document.getElementById(pageId);
            if (activePage) {
                activePage.style.display = 'block';
                const title = pageId.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                document.title = `${title} | Yaswanth Fleet`;
            } else {
                 document.title = 'Dashboard | Yaswanth Fleet';
            }
            
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            const activeNavId = pageToNavMap[pageId];
            if(activeNavId) {
                document.querySelectorAll(`#${activeNavId}`).forEach(el => el.classList.add('active'));
            }

            document.getElementById('mobile-menu').classList.add('hidden');

            if (pageId === 'bus-wise-audit') createOrUpdateCharts();
            if (pageId.endsWith('-selection')) highlightCurrentMonth();
        }

        // ======================================================= //
        // AUDIT FUNCTIONS                                         //
        // ======================================================= //
        async function showAuditFile(month) {
            showLoader();
            document.getElementById('audit-file-month').textContent = month;
            try {
                const snapshot = await database.ref(`auditData/${month}`).once('value');
                const monthData = snapshot.val() || [];
                const dataArray = Array.isArray(monthData) ? monthData : Object.values(monthData);
                buildTableWithData(dataArray);
                showPage('audit-file');
            } catch (error) {
                console.error("Could not fetch audit data: ", error);
                showToast("Error fetching data.", "error");
            } finally {
                hideLoader();
            }
        }
        
        async function saveTableData() {
            showLoader();
            const month = document.getElementById('audit-file-month').textContent;
            if (!month) { hideLoader(); return showToast('Error: No month selected.', 'error'); }
            const monthData = [];
            document.querySelectorAll('#audit-table-body tr.data-row').forEach(row => {
                const busNumber = row.querySelector('.bus-number-cell').innerText.trim().toUpperCase();
                const revenue = parseCurrency(row.querySelector('.revenue-cell').innerText);
                const expense = parseCurrency(row.querySelector('.expense-cell').innerText);
                if (busNumber || revenue || expense) {
                    monthData.push({ busNumber, revenue, expense });
                }
            });
            
            try {
                await database.ref(`auditData/${month}`).set(monthData);
                showToast(`Audit data for ${month} saved successfully!`, 'success');
            } catch (error) {
                console.error("Error saving audit data: ", error);
                showToast("Error saving data. See console for details.", 'error');
            } finally {
                hideLoader();
            }
        }
        
        // ======================================================= //
        // DIESEL AUDIT FUNCTIONS                                //
        // ======================================================= //
        async function showDieselFile(month) {
            showLoader();
            document.getElementById('diesel-file-month').textContent = month;
            try {
                const snapshot = await database.ref(`dieselData/${month}`).once('value');
                const dieselData = snapshot.val() || {};
                buildDieselTable(month, dieselData);
                showPage('diesel-file');
            } catch (error) {
                console.error("Could not fetch diesel data: ", error);
                showToast("Error fetching data.", 'error');
            } finally {
                hideLoader();
            }
        }

        function buildDieselTable(month, data) {
            const year = new Date().getFullYear();
            const monthIndex = MONTH_NAMES.indexOf(month);
            const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
            const table = document.getElementById('diesel-table');

            table.querySelector('thead').innerHTML = '';
            table.querySelector('tbody').innerHTML = '';
            table.querySelector('tfoot').innerHTML = '';

            let headerRowHTML = '<tr><th class="p-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sticky left-0 bg-slate-100 z-20">Bus No.</th>';
            for (let i = 1; i <= daysInMonth; i++) {
                headerRowHTML += `<th class="p-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">${i}</th>`;
            }
            headerRowHTML += '<th class="p-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sticky right-0 bg-slate-100 z-20">Bus Total</th></tr>';
            table.querySelector('thead').innerHTML = headerRowHTML;

            DIESEL_BUS_NUMBERS.forEach(bus => {
                let bodyRowHTML = `<tr data-bus="${bus}">`;
                bodyRowHTML += `<td class="p-2 whitespace-nowrap font-semibold text-slate-700 sticky left-0 bg-slate-50 z-10">${bus}</td>`;
                for (let i = 1; i <= daysInMonth; i++) {
                    const value = data[bus] && data[bus][i] ? data[bus][i] : '';
                    bodyRowHTML += `<td class="p-1 whitespace-nowrap text-center text-slate-800 diesel-input-cell" contenteditable="true" data-day="${i}" oninput="handleNumericInput(this, updateDieselTotals)" onblur="formatCellAsCurrency(this, false)">${value}</td>`;
                }
                bodyRowHTML += `<td class="p-2 whitespace-nowrap font-bold text-indigo-700 sticky right-0 bg-slate-100 z-10 bus-total-cell">0</td>`;
                bodyRowHTML += '</tr>';
                table.querySelector('tbody').innerHTML += bodyRowHTML;
            });

            let footerRowHTML = '<tr><td class="p-3 font-semibold text-slate-800 sticky left-0 bg-slate-200 z-10">Daily Total</td>';
            for (let i = 1; i <= daysInMonth; i++) {
                footerRowHTML += `<td class="p-3 whitespace-nowrap font-bold text-center day-total-cell" data-day-total="${i}">0</td>`;
            }
            footerRowHTML += `<td class="p-3 whitespace-nowrap font-extrabold text-lg text-indigo-800 sticky right-0 bg-slate-300 z-10 grand-total-cell">0</td></tr>`;
            table.querySelector('tfoot').innerHTML = footerRowHTML;

            updateDieselTotals();
            setupDieselTableHover();
        }

        function setupDieselTableHover() {
            const table = document.getElementById('diesel-table');
            const allCells = table.querySelectorAll('th, td');
            
            const clearHighlights = () => {
                allCells.forEach(c => {
                    c.classList.remove('highlight-row', 'highlight-col');
                });
            };

            allCells.forEach(cell => {
                cell.addEventListener('mouseover', () => {
                    clearHighlights();
                    const rowIndex = cell.parentElement.rowIndex;
                    const colIndex = cell.cellIndex;
                    
                    const rowCells = table.rows[rowIndex].cells;
                    for (let i = 0; i < rowCells.length; i++) {
                        rowCells[i].classList.add('highlight-row');
                    }
                    
                    for (let i = 0; i < table.rows.length; i++) {
                        table.rows[i].cells[colIndex].classList.add('highlight-col');
                    }
                });
            });
            table.addEventListener('mouseleave', clearHighlights);
        }
        
        function updateDieselTotals() {
            let grandTotal = 0;
            const daysInMonth = document.querySelectorAll('#diesel-table-head th').length - 2;

            document.querySelectorAll('#diesel-table-body tr').forEach(row => {
                let rowTotal = 0;
                row.querySelectorAll('.diesel-input-cell').forEach(cell => {
                    rowTotal += parseCurrency(cell.innerText);
                });
                row.querySelector('.bus-total-cell').innerText = rowTotal > 0 ? rowTotal.toLocaleString('en-IN') : '0';
                grandTotal += rowTotal;
            });

            for (let i = 1; i <= daysInMonth; i++) {
                let colTotal = 0;
                document.querySelectorAll(`#diesel-table-body .diesel-input-cell[data-day="${i}"]`).forEach(cell => {
                    colTotal += parseCurrency(cell.innerText);
                });
                document.querySelector(`#diesel-table-foot .day-total-cell[data-day-total="${i}"]`).innerText = colTotal > 0 ? colTotal.toLocaleString('en-IN') : '0';
            }

            document.querySelector('.grand-total-cell').innerText = grandTotal > 0 ? grandTotal.toLocaleString('en-IN') : '0';
        }

        async function saveDieselData() {
            showLoader();
            const month = document.getElementById('diesel-file-month').textContent;
            if (!month) { hideLoader(); return showToast('Error: No month selected.', 'error'); }

            const monthData = {};
            document.querySelectorAll('#diesel-table-body tr').forEach(row => {
                const busNumber = row.dataset.bus;
                const busDayData = {};
                let hasData = false;
                row.querySelectorAll('.diesel-input-cell').forEach(cell => {
                    const day = cell.dataset.day;
                    const value = parseCurrency(cell.innerText);
                    if (value > 0) {
                        busDayData[day] = value;
                        hasData = true;
                    }
                });
                if(hasData) monthData[busNumber] = busDayData;
            });

            try {
                await database.ref(`dieselData/${month}`).set(monthData);
                showToast(`Diesel data for ${month} saved successfully!`, 'success');
            } catch (error) {
                console.error("Error saving diesel data: ", error);
                showToast("Error saving data. See console for details.", 'error');
            } finally {
                hideLoader();
            }
        }
        
        // ======================================================= //
        // REPORTING & CHART FUNCTIONS                             //
        // ======================================================= //
        async function createOrUpdateCharts() {
            showLoader();
            try {
                const snapshot = await database.ref('auditData').once('value');
                const db = snapshot.val() || {};
                
                const hasData = Object.keys(db).length > 0 && Object.values(db).some(month => month && (Array.isArray(month) ? month.length > 0 : Object.keys(month).length > 0));

                document.getElementById('charts-container').style.display = hasData ? 'grid' : 'none';
                document.getElementById('bus-specific-analysis-section').style.display = hasData ? 'block' : 'none';
                document.getElementById('no-charts-message').style.display = hasData ? 'none' : 'flex';
                document.getElementById('bus-details-container').classList.add('hidden');

                if (!hasData) return;
                
                const busData = {};
                MONTH_NAMES.forEach(month => {
                    if (db[month]) {
                        const monthData = Array.isArray(db[month]) ? db[month] : Object.values(db[month]);
                        monthData.forEach(entry => {
                            if (!entry || !entry.busNumber) return;
                            const bus = entry.busNumber.toUpperCase();
                            if (!bus) return;
                            if (!busData[bus]) { busData[bus] = { monthlyData: {} }; }
                            busData[bus].monthlyData[month] = {
                                revenue: entry.revenue || 0,
                                expense: entry.expense || 0,
                                profit: (entry.revenue || 0) - (entry.expense || 0)
                            };
                        });
                    }
                });

                const aggregatedTotals = {};
                Object.keys(busData).forEach(bus => {
                    aggregatedTotals[bus] = { revenue: 0, profit: 0, loss: 0 };
                    Object.values(busData[bus].monthlyData).forEach(data => {
                        aggregatedTotals[bus].revenue += data.revenue;
                        if (data.profit >= 0) {
                            aggregatedTotals[bus].profit += data.profit;
                        } else {
                            aggregatedTotals[bus].loss += data.profit;
                        }
                    });
                });
                const labels = Object.keys(aggregatedTotals).sort();
                createBusProfitLossChart(labels, labels.map(bus => aggregatedTotals[bus].profit), labels.map(bus => aggregatedTotals[bus].loss));
                createRevenuePieChart(labels, labels.map(bus => aggregatedTotals[bus].revenue));
                populateBusSelector(Object.keys(busData).sort(), busData);
            } catch (error) {
                console.error("Could not create charts: ", error);
                showToast("Error generating reports.", "error");
                document.getElementById('charts-container').style.display = 'none';
                document.getElementById('no-charts-message').style.display = 'flex';
            } finally {
                hideLoader();
            }
        }

        // ======================================================= //
        // PAYROLL FUNCTIONS                                       //
        // ======================================================= //
        async function showPayrollFile(month) {
            showLoader();
            document.getElementById('payroll-file-month').textContent = month;
            try {
                const snapshot = await database.ref(`payrollData/${month}`).once('value');
                const payrollData = snapshot.val() || [];
                const dataArray = Array.isArray(payrollData) ? payrollData : Object.values(payrollData);
                buildPayrollTable(dataArray);
                showPage('payroll-file');
            } catch (error) {
                console.error("Could not fetch payroll data: ", error);
                showToast("Error fetching data.", 'error');
            } finally {
                hideLoader();
            }
        }

        async function savePayrollData() {
            showLoader();
            const month = document.getElementById('payroll-file-month').textContent;
            if (!month) { hideLoader(); return showToast('Error: No payroll month selected.', 'error'); }

            const data = [];
            document.querySelectorAll('#payroll-table-body tr.data-row').forEach(row => {
                const name = row.querySelector('.name-cell').innerText.trim();
                if (name) {
                    data.push({
                        name,
                        vehicle: row.querySelector('.vehicle-cell').innerText.trim().toUpperCase(),
                        km: parseCurrency(row.querySelector('.km-cell').innerText),
                        rate: parseCurrency(row.querySelector('.rate-cell').innerText),
                        insurance: parseCurrency(row.querySelector('.insurance-cell').innerText),
                        oilSaved: parseCurrency(row.querySelector('.oil-saved-cell').innerText),
                        incomeTax: parseCurrency(row.querySelector('.incometax-cell').innerText),
                        penalty: parseCurrency(row.querySelector('.penalty-cell').innerText),
                        lessOther: parseCurrency(row.querySelector('.less-other-cell').innerText)
                    });
                }
            });
            
            try {
                await database.ref(`payrollData/${month}`).set(data);
                showToast(`Payroll data for ${month} saved successfully!`, 'success');
            } catch (error) {
                console.error("Error saving payroll data: ", error);
                showToast("Error saving data. See console for details.", 'error');
            } finally {
                hideLoader();
            }
        }

        // ======================================================= //
        // --- HELPER & UI BUILDER FUNCTIONS ---                   //
        // ======================================================= //
        function buildTableWithData(data) {
            const tableBody = document.getElementById('audit-table-body');
            tableBody.innerHTML = '';
            if (data.length === 0) {
                 tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-10 text-slate-500">No audit records found for this month. Click 'Add Row' to start.</td></tr>`;
                 updateTableFooter();
                 return;
            }
            data.forEach((rowData, index) => {
                const i = index + 1;
                const row = document.createElement('tr');
                row.className = `data-row ${i % 2 === 0 ? 'bg-slate-100' : 'bg-slate-50'}`;
                row.id = `row-${i}`;
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${i}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-slate-900 bus-number-cell" contenteditable="true" data-placeholder="Enter bus no." oninput="updateRowAndTotals()">${rowData.busNumber || ''}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-green-600 revenue-cell" contenteditable="true" data-placeholder="0" oninput="handleNumericInput(this, updateRowAndTotals)" onblur="formatCellAsCurrency(this);">${rowData.revenue ? rowData.revenue.toLocaleString('en-IN') : ''}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-red-600 expense-cell" contenteditable="true" data-placeholder="0" oninput="handleNumericInput(this, updateRowAndTotals)" onblur="formatCellAsCurrency(this);">${rowData.expense ? rowData.expense.toLocaleString('en-IN') : ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium profit-cell"></td>
                    <td class="px-6 py-4 text-center"><button onclick="deleteRow(${i})" class="text-red-400 hover:text-red-600 font-bold text-xl transition-colors">&times;</button></td>
                `;
                tableBody.appendChild(row);
            });
            updateRowAndTotals();
        }
        function addRow() {
            const tableBody = document.getElementById('audit-table-body');
             if (tableBody.querySelector('td[colspan="6"]')) {
                tableBody.innerHTML = '';
            }
            const newIndex = tableBody.rows.length + 1;
            const newRow = document.createElement('tr');
            newRow.className = `data-row ${newIndex % 2 === 0 ? 'bg-slate-100' : 'bg-slate-50'}`;
            newRow.id = `row-${newIndex}`;
            newRow.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${newIndex}</td>
                <td class="px-4 py-2 whitespace-nowrap text-sm text-slate-900 bus-number-cell" contenteditable="true" data-placeholder="Enter bus no." oninput="updateRowAndTotals()"></td>
                <td class="px-4 py-2 whitespace-nowrap text-sm text-green-600 revenue-cell" contenteditable="true" data-placeholder="0" oninput="handleNumericInput(this, updateRowAndTotals)" onblur="formatCellAsCurrency(this);"></td>
                <td class="px-4 py-2 whitespace-nowrap text-sm text-red-600 expense-cell" contenteditable="true" data-placeholder="0" oninput="handleNumericInput(this, updateRowAndTotals)" onblur="formatCellAsCurrency(this);"></td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium profit-cell"></td>
                <td class="px-6 py-4 text-center"><button onclick="deleteRow(${newIndex})" class="text-red-400 hover:text-red-600 font-bold text-xl transition-colors">&times;</button></td>
            `;
            tableBody.appendChild(newRow);
            newRow.querySelector('.bus-number-cell').focus();
        }
        function deleteRow(rowIndex) {
            document.getElementById(`row-${rowIndex}`).remove();
            const tableBody = document.getElementById('audit-table-body');
            Array.from(tableBody.rows).forEach((row, index) => {
                const i = index + 1;
                row.id = `row-${i}`;
                row.cells[0].textContent = i;
                row.cells[5].querySelector('button').setAttribute('onclick', `deleteRow(${i})`);
            });
            updateRowAndTotals();
             if (tableBody.rows.length === 0) buildTableWithData([]);
        }
        function updateRowAndTotals() {
            document.querySelectorAll('#audit-table-body tr.data-row').forEach(row => {
                const profitCell = row.querySelector('.profit-cell');
                if (!profitCell) return;
                const revenue = parseCurrency(row.querySelector('.revenue-cell').innerText);
                const expense = parseCurrency(row.querySelector('.expense-cell').innerText);
                const profit = revenue - expense;
                profitCell.innerText = '' + profit.toLocaleString('en-IN');
                profitCell.classList.toggle('text-green-600', profit >= 0);
                profitCell.classList.toggle('text-red-600', profit < 0);
            });
            updateTableFooter();
        }
        function updateTableFooter() {
            const tableFoot = document.getElementById('audit-table-foot');
            const totalRevenue = sumColumn('#audit-table-body .revenue-cell');
            const totalExpense = sumColumn('#audit-table-body .expense-cell');
            const totalProfit = totalRevenue - totalExpense;
            tableFoot.innerHTML = `
                <tr>
                    <td class="px-6 py-4 text-sm uppercase tracking-wider" colspan="2">Total</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600">${totalRevenue.toLocaleString('en-IN')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600">${totalExpense.toLocaleString('en-IN')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${totalProfit >= 0 ? 'text-green-600' : 'text-red-600'}">${totalProfit.toLocaleString('en-IN')}</td>
                    <td class="px-6 py-4"></td>
                </tr>`;
        }
        function createBusProfitLossChart(labels, profitData, lossData) {
            const ctx = document.getElementById('busProfitLossChart').getContext('2d');
            if (profitLossChartInstance) profitLossChartInstance.destroy();
            profitLossChartInstance = new Chart(ctx, {
                type: 'bar', data: { labels, datasets: [
                    { label: 'Profit', data: profitData, backgroundColor: 'rgba(34, 197, 94, 0.7)', borderColor: 'rgba(22, 163, 74, 1)', borderWidth: 1, borderRadius: 4 },
                    { label: 'Loss', data: lossData, backgroundColor: 'rgba(239, 68, 68, 0.7)', borderColor: 'rgba(220, 38, 38, 1)', borderWidth: 1, borderRadius: 4 }
                ]},
                options: { responsive: true, scales: { y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { callback: value => '' + value.toLocaleString('en-IN') }}}, plugins: { tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${c.raw.toLocaleString('en-IN')}` }}}}
            });
        }
        function createRevenuePieChart(labels, revenueData) {
            const ctx = document.getElementById('revenuePieChart').getContext('2d');
            if (revenuePieChartInstance) revenuePieChartInstance.destroy();
            revenuePieChartInstance = new Chart(ctx, {
                type: 'doughnut', data: { labels, datasets: [{
                    label: 'Total Revenue', data: revenueData,
                    backgroundColor: ['#4f46e5', '#10b981', '#f59e0b', '#3b82f6', '#6366f1', '#ec4899', '#8b5cf6'],
                    hoverOffset: 8, borderColor: '#f1f5f9'
                }]},
                options: { responsive: true, plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: (c) => `${c.label}: ${c.raw.toLocaleString('en-IN')}` }}}}
            });
        }
        function createMonthlyBusChart(labels, revenueData, expenseData, profitData) {
            const ctx = document.getElementById('monthlyBusChart').getContext('2d');
            if (monthlyBusChartInstance) monthlyBusChartInstance.destroy();
            monthlyBusChartInstance = new Chart(ctx, {
                type: 'line', data: { labels, datasets: [
                    { label: 'Revenue', data: revenueData, borderColor: 'rgba(34, 197, 94, 1)', backgroundColor: 'rgba(34, 197, 94, 0.1)', fill: true, tension: 0.3 },
                    { label: 'Expenses', data: expenseData, borderColor: 'rgba(239, 68, 68, 1)', backgroundColor: 'rgba(239, 68, 68, 0.1)', fill: true, tension: 0.3 },
                    { label: 'Profit', data: profitData, borderColor: 'rgba(79, 70, 229, 1)', backgroundColor: 'rgba(79, 70, 229, 0.1)', fill: true, tension: 0.3 }
                ]},
                options: { responsive: true, scales: { y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { callback: value => '' + value.toLocaleString('en-IN') }}}, plugins: { tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${c.raw.toLocaleString('en-IN')}` }}}}
            });
        }
        function buildPayrollTable(data) {
            const tableBody = document.getElementById('payroll-table-body');
            tableBody.innerHTML = '';
            if (data.length === 0) {
                 tableBody.innerHTML = `<tr><td colspan="14" class="text-center py-10 text-slate-500">No payroll records found for this month. Click 'Add Row' to start.</td></tr>`;
                 updatePayrollFooter();
                 return;
            }
            data.forEach((d, index) => {
                const i = index + 1;
                const row = document.createElement('tr');
                row.className = `data-row ${i % 2 === 0 ? 'bg-slate-100' : 'bg-slate-50'}`;
                row.id = `payroll-row-${i}`;
                row.innerHTML = `
                    <td class="p-2 whitespace-nowrap text-slate-900 name-cell" contenteditable="true" data-placeholder="Driver Name">${d.name || ''}</td>
                    <td class="p-2 whitespace-nowrap text-slate-900 vehicle-cell" contenteditable="true" data-placeholder="Vehicle No">${d.vehicle || ''}</td>
                    <td class="p-2 whitespace-nowrap text-slate-700 km-cell" contenteditable="true" data-placeholder="0" oninput="handleNumericInput(this, updatePayrollRowAndTotals)" onblur="formatCellAsCurrency(this, false);">${d.km ? d.km.toLocaleString('en-IN') : ''}</td>
                    <td class="p-2 whitespace-nowrap text-slate-700 rate-cell" contenteditable="true" data-placeholder="0" oninput="handleNumericInput(this, updatePayrollRowAndTotals)" onblur="formatCellAsCurrency(this);">${d.rate ? d.rate.toLocaleString('en-IN') : ''}</td>
                    <td class="p-2 whitespace-nowrap font-medium bg-slate-200/60 amount-payable-cell"></td>
                    <td class="p-2 whitespace-nowrap text-blue-600 insurance-cell" contenteditable="true" data-placeholder="0" oninput="handleNumericInput(this, updatePayrollRowAndTotals)" onblur="formatCellAsCurrency(this);">${d.insurance ? d.insurance.toLocaleString('en-IN') : ''}</td>
                    <td class="p-2 whitespace-nowrap text-blue-600 oil-saved-cell" contenteditable="true" data-placeholder="0" oninput="handleNumericInput(this, updatePayrollRowAndTotals)" onblur="formatCellAsCurrency(this);">${d.oilSaved ? d.oilSaved.toLocaleString('en-IN') : ''}</td>
                    <td class="p-2 whitespace-nowrap font-medium text-blue-700 bg-slate-200/60 total-payable-cell"></td>
                    <td class="p-2 whitespace-nowrap text-red-600 incometax-cell" contenteditable="true" data-placeholder="0" oninput="handleNumericInput(this, updatePayrollRowAndTotals)" onblur="formatCellAsCurrency(this);">${d.incomeTax ? d.incomeTax.toLocaleString('en-IN') : ''}</td>
                    <td class="p-2 whitespace-nowrap text-red-600 penalty-cell" contenteditable="true" data-placeholder="0" oninput="handleNumericInput(this, updatePayrollRowAndTotals)" onblur="formatCellAsCurrency(this);">${d.penalty ? d.penalty.toLocaleString('en-IN') : ''}</td>
                    <td class="p-2 whitespace-nowrap text-red-600 less-other-cell" contenteditable="true" data-placeholder="0" oninput="handleNumericInput(this, updatePayrollRowAndTotals)" onblur="formatCellAsCurrency(this);">${d.lessOther ? d.lessOther.toLocaleString('en-IN') : ''}</td>
                    <td class="p-2 whitespace-nowrap font-medium text-red-700 bg-slate-200/60 total-deduction-cell"></td>
                    <td class="p-2 whitespace-nowrap font-bold text-lg bg-indigo-100 net-payable-cell"></td>
                    <td class="p-2 text-center"><button onclick="deletePayrollRow(${i})" class="text-red-400 hover:text-red-600 font-bold text-xl transition-colors">&times;</button></td>
                `;
                tableBody.appendChild(row);
            });
            updatePayrollRowAndTotals();
        }
        function addPayrollRow() {
            const tableBody = document.getElementById('payroll-table-body');
            if(tableBody.querySelector('td[colspan="14"]')) tableBody.innerHTML = '';
            const i = tableBody.rows.length + 1;
            const row = document.createElement('tr');
            row.className = `data-row ${i % 2 === 0 ? 'bg-slate-100' : 'bg-slate-50'}`;
            row.id = `payroll-row-${i}`;
            row.innerHTML = `
                <td class="p-2 whitespace-nowrap text-slate-900 name-cell" contenteditable="true" data-placeholder="Driver Name"></td>
                <td class="p-2 whitespace-nowrap text-slate-900 vehicle-cell" contenteditable="true" data-placeholder="Vehicle No"></td>
                <td class="p-2 whitespace-nowrap text-slate-700 km-cell" contenteditable="true" data-placeholder="0" oninput="handleNumericInput(this, updatePayrollRowAndTotals)" onblur="formatCellAsCurrency(this, false);"></td>
                <td class="p-2 whitespace-nowrap text-slate-700 rate-cell" contenteditable="true" data-placeholder="0" oninput="handleNumericInput(this, updatePayrollRowAndTotals)" onblur="formatCellAsCurrency(this);"></td>
                <td class="p-2 whitespace-nowrap font-medium bg-slate-200/60 amount-payable-cell"></td>
                <td class="p-2 whitespace-nowrap text-blue-600 insurance-cell" contenteditable="true" data-placeholder="0" oninput="handleNumericInput(this, updatePayrollRowAndTotals)" onblur="formatCellAsCurrency(this);"></td>
                <td class="p-2 whitespace-nowrap text-blue-600 oil-saved-cell" contenteditable="true" data-placeholder="0" oninput="handleNumericInput(this, updatePayrollRowAndTotals)" onblur="formatCellAsCurrency(this);"></td>
                <td class="p-2 whitespace-nowrap font-medium text-blue-700 bg-slate-200/60 total-payable-cell"></td>
                <td class="p-2 whitespace-nowrap text-red-600 incometax-cell" contenteditable="true" data-placeholder="0" oninput="handleNumericInput(this, updatePayrollRowAndTotals)" onblur="formatCellAsCurrency(this);"></td>
                <td class="p-2 whitespace-nowrap text-red-600 penalty-cell" contenteditable="true" data-placeholder="0" oninput="handleNumericInput(this, updatePayrollRowAndTotals)" onblur="formatCellAsCurrency(this);"></td>
                <td class="p-2 whitespace-nowrap text-red-600 less-other-cell" contenteditable="true" data-placeholder="0" oninput="handleNumericInput(this, updatePayrollRowAndTotals)" onblur="formatCellAsCurrency(this);"></td>
                <td class="p-2 whitespace-nowrap font-medium text-red-700 bg-slate-200/60 total-deduction-cell"></td>
                <td class="p-2 whitespace-nowrap font-bold text-lg bg-indigo-100 net-payable-cell"></td>
                <td class="p-2 text-center"><button onclick="deletePayrollRow(${i})" class="text-red-400 hover:text-red-600 font-bold text-xl transition-colors">&times;</button></td>
            `;
            tableBody.appendChild(row);
            row.querySelector('.name-cell').focus();
        }
        function deletePayrollRow(rowIndex) {
            document.getElementById(`payroll-row-${rowIndex}`).remove();
            const tableBody = document.getElementById('payroll-table-body');
            Array.from(tableBody.rows).forEach((row, index) => {
                const i = index + 1;
                row.id = `payroll-row-${i}`;
                row.cells[13].querySelector('button').setAttribute('onclick', `deletePayrollRow(${i})`);
            });
            updatePayrollRowAndTotals();
            if(tableBody.rows.length === 0) buildPayrollTable([]);
        }
        function updatePayrollRowAndTotals() {
            document.querySelectorAll('#payroll-table-body tr.data-row').forEach(row => {
                const optedKm = parseCurrency(row.querySelector('.km-cell').innerText);
                const slabRate = parseCurrency(row.querySelector('.rate-cell').innerText);
                const insurance = parseCurrency(row.querySelector('.insurance-cell').innerText);
                const oilSaved = parseCurrency(row.querySelector('.oil-saved-cell').innerText);
                const incomeTax = parseCurrency(row.querySelector('.incometax-cell').innerText);
                const penalty = parseCurrency(row.querySelector('.penalty-cell').innerText);
                const lessOther = parseCurrency(row.querySelector('.less-other-cell').innerText);

                const amountPayable = optedKm * slabRate;
                const totalPayable = amountPayable + insurance + oilSaved;
                const totalDeduction = incomeTax + penalty + lessOther;
                const netPayable = totalPayable - totalDeduction;

                row.querySelector('.amount-payable-cell').innerText = '' + amountPayable.toLocaleString('en-IN');
                row.querySelector('.total-payable-cell').innerText = '' + totalPayable.toLocaleString('en-IN');
                row.querySelector('.total-deduction-cell').innerText = '' + totalDeduction.toLocaleString('en-IN');
                const netPayableCell = row.querySelector('.net-payable-cell');
                netPayableCell.innerText = '' + netPayable.toLocaleString('en-IN');
                netPayableCell.classList.toggle('text-green-700', netPayable >= 0);
                netPayableCell.classList.toggle('text-red-700', netPayable < 0);
            });
            updatePayrollFooter();
        }
        function updatePayrollFooter() {
            const footer = document.getElementById('payroll-table-foot');
            const totalAmountPayable = sumColumn('#payroll-table-body .amount-payable-cell');
            const totalPayable = sumColumn('#payroll-table-body .total-payable-cell');
            const totalDeduction = sumColumn('#payroll-table-body .total-deduction-cell');
            const netPayable = sumColumn('#payroll-table-body .net-payable-cell');
            footer.innerHTML = `
                <tr>
                    <td class="p-3 text-sm uppercase tracking-wider" colspan="4">Total</td>
                    <td class="p-3 whitespace-nowrap text-sm">${totalAmountPayable.toLocaleString('en-IN')}</td>
                    <td class="p-3 whitespace-nowrap text-sm" colspan="2"></td>
                    <td class="p-3 whitespace-nowrap text-sm text-blue-700">${totalPayable.toLocaleString('en-IN')}</td>
                    <td class="p-3 whitespace-nowrap text-sm" colspan="3"></td>
                    <td class="p-3 whitespace-nowrap text-sm text-red-700">${totalDeduction.toLocaleString('en-IN')}</td>
                    <td class="p-3 whitespace-nowrap text-sm font-extrabold ${netPayable >= 0 ? 'text-green-700' : 'text-red-700'}">${netPayable.toLocaleString('en-IN')}</td>
                    <td class="p-3"></td>
                </tr>`;
        }
        
        // --- UTILITY FUNCTIONS ---
        const parseCurrency = (text) => parseFloat(String(text).replace(/[^0-9.-]+/g, "")) || 0;
        const sumColumn = (selector) => Array.from(document.querySelectorAll(selector)).reduce((acc, cell) => acc + parseCurrency(cell.innerText), 0);
        function formatCellAsCurrency(cell, useFractions = true) {
            if (!cell.innerText) return;
            let value = parseCurrency(cell.innerText);
            if (isNaN(value)) value = 0;
            const options = useFractions ? { minimumFractionDigits: 2, maximumFractionDigits: 2 } : { maximumFractionDigits: 2 };
            cell.innerText = value.toLocaleString('en-IN', options);
        }
        function handleNumericInput(cell, callback) {
            // This is a simple way to guide users; it doesn't prevent copy-pasting text.
            // A more robust solution would be more complex and might interfere with user input methods.
            if (/[^0-9.,]/.test(cell.innerText)) {
                 // Briefly show invalid input before removing it
                setTimeout(() => {
                    const originalText = cell.innerText;
                    const sanitized = originalText.replace(/[^0-9.,]/g, '');
                    if (originalText !== sanitized) {
                        cell.innerText = sanitized;
                        // Move cursor to end
                        const range = document.createRange();
                        const sel = window.getSelection();
                        range.selectNodeContents(cell);
                        range.collapse(false);
                        sel.removeAllRanges();
                        sel.addRange(range);
                    }
                }, 10);
            }
            if (callback) callback();
        }
        function filterAuditTable() {
            const query = document.getElementById('audit-search').value.toUpperCase();
            document.querySelectorAll('#audit-table-body tr.data-row').forEach(row => {
                const busCell = row.querySelector('.bus-number-cell');
                row.style.display = busCell.innerText.toUpperCase().includes(query) ? '' : 'none';
            });
        }
        function filterPayrollTable() {
            const query = document.getElementById('payroll-search').value.toUpperCase();
            document.querySelectorAll('#payroll-table-body tr.data-row').forEach(row => {
                const nameCell = row.querySelector('.name-cell');
                row.style.display = nameCell.innerText.toUpperCase().includes(query) ? '' : 'none';
            });
        }

        // --- EVENT LISTENERS & INITIALIZATION ---
        document.getElementById('mobile-menu-button').addEventListener('click', () => {
            document.getElementById('mobile-menu').classList.toggle('hidden');
        });
        window.onload = () => {
             document.getElementById('current-year').textContent = new Date().getFullYear();
             showPage('home');
        };
    </script>

</body>
</html>
